<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>OurSales • Indicadores</title>
    <link rel="icon" type="image/svg+xml" href="frontend/favicon.svg" />
    <!-- Resource Hints -->
    <link rel="preconnect" href="https://cdn.jsdelivr.net" />
    <link rel="dns-prefetch" href="https://cdn.jsdelivr.net" />
    <!-- Critical CSS -->
    <link rel="stylesheet" href="frontend/assets/css/style.css" />
    <link rel="stylesheet" href="frontend/assets/css/fix-animations.css" />
    <!-- Defer non-critical CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@latest/dist/tabler-icons.min.css" data-defer />
    <!-- Performance Optimizer (load early) -->
    <script src="frontend/assets/js/performance-optimizer.js"></script>
    <!-- Defer heavy libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-gauge@0.3.0/dist/chartjs-gauge.min.js" defer></script>
    <style>
      .dashboard-container {
        max-width: 1600px;
        margin: 0 auto;
        padding: var(--space-4);
        width: 100%;
        box-sizing: border-box;
      }

      main {
        max-width: 100% !important;
        width: 100% !important;
        padding: var(--space-4) !important;
      }

      .dashboard-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--space-6);
        flex-wrap: wrap;
        gap: var(--space-4);
      }

      .dashboard-header h2 {
        margin: 0;
        display: flex;
        align-items: center;
        gap: var(--space-2);
        font-size: var(--text-2xl);
      }

      .dashboard-actions {
        display: flex;
        gap: var(--space-3);
        align-items: center;
        flex-wrap: wrap;
      }

      .period-filter {
        display: flex;
        align-items: center;
        gap: var(--space-2);
        background: var(--gray-50);
        padding: var(--space-1) var(--space-2);
        border-radius: var(--radius-md);
        border: 1px solid var(--gray-200);
      }

      .date-input {
        padding: var(--space-1) var(--space-2);
        border: 1px solid var(--gray-300);
        border-radius: var(--radius-sm);
        font-size: var(--text-sm);
        background: white;
        color: var(--text-primary);
        font-weight: 500;
        min-width: 120px;
      }

      .date-input:focus {
        outline: none;
        border-color: var(--primary-500);
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
      }

      .date-separator {
        font-size: var(--text-sm);
        color: var(--text-secondary);
        font-weight: 500;
        padding: 0 var(--space-1);
      }

      .btn-filter-ok {
        background: var(--primary-600);
        color: white;
        border: none;
        padding: var(--space-2) var(--space-4);
        border-radius: var(--radius-md);
        cursor: pointer;
        font-weight: 600;
        font-size: var(--text-sm);
        transition: all 0.2s ease;
        min-width: 50px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        outline: none;
      }

      .btn-filter-ok:focus {
        outline: none;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }

      .btn-filter-ok:hover {
        background: var(--primary-700);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
      }

      .btn-filter-ok:active {
        background: var(--primary-800);
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
      }

      .charts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: var(--space-4);
        margin-bottom: var(--space-4);
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
      }

      .chart-card {
        background: white;
        padding: var(--space-4);
        border-radius: var(--radius-lg);
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        border: 1px solid var(--gray-200);
        position: relative;
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
        overflow: hidden;
      }

      .chart-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--space-4);
        padding-bottom: var(--space-3);
        border-bottom: 1px solid var(--gray-200);
      }

      .chart-card-title {
        font-size: var(--text-lg);
        font-weight: 600;
        color: var(--text-primary);
      }

      .chart-card-actions {
        display: flex;
        gap: var(--space-2);
        align-items: center;
      }

      .chart-card-actions button {
        background: transparent;
        border: none;
        cursor: pointer;
        padding: var(--space-1);
        color: var(--text-secondary);
        font-size: var(--text-lg);
        transition: color var(--transition-fast);
        border-radius: var(--radius-sm);
      }

      .chart-card-actions button:hover {
        color: var(--text-primary);
        background: var(--gray-100);
      }

      .chart-card-filter {
        margin-bottom: var(--space-3);
      }

      .chart-card-filter select {
        width: 100%;
        padding: var(--space-2) var(--space-3);
        border: 1px solid var(--gray-300);
        border-radius: var(--radius-md);
        font-size: var(--text-sm);
        background: white;
      }

      .chart-container {
        position: relative;
        height: 350px;
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .chart-container canvas {
        max-width: 100% !important;
        height: 100% !important;
        width: 100% !important;
      }

      .gauge-container {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: var(--space-4);
        padding: var(--space-4) 0;
        width: 100%;
      }

      .gauge-item {
        text-align: center;
      }

      .gauge-item canvas {
        max-width: 100%;
        height: 150px;
      }

      .gauge-label {
        margin-top: var(--space-2);
        font-size: var(--text-sm);
        color: var(--text-secondary);
        font-weight: 500;
      }

      .gauge-value {
        font-size: var(--text-xl);
        font-weight: 700;
        color: var(--text-primary);
        margin-top: var(--space-1);
      }

      .bar-chart-list {
        max-height: 400px;
        overflow-y: auto;
      }

      .bar-chart-item {
        margin-bottom: var(--space-4);
        padding-bottom: var(--space-4);
        border-bottom: 1px solid var(--gray-200);
      }

      .bar-chart-item:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
      }

      .bar-chart-label {
        display: flex;
        justify-content: space-between;
        margin-bottom: var(--space-2);
        font-size: var(--text-sm);
      }

      .bar-chart-name {
        font-weight: 500;
        color: var(--text-primary);
      }

      .bar-chart-percent {
        font-weight: 600;
        color: var(--text-secondary);
      }

      .bar-chart-progress {
        height: 24px;
        background: var(--gray-200);
        border-radius: var(--radius-md);
        overflow: hidden;
        position: relative;
      }

      .bar-chart-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--primary-500), var(--primary-600));
        border-radius: var(--radius-md);
        transition: width 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: flex-end;
        padding-right: var(--space-2);
        color: white;
        font-size: var(--text-xs);
        font-weight: 600;
      }

      .bar-chart-fill.low {
        background: linear-gradient(90deg, #ef4444, #dc2626);
      }

      .bar-chart-fill.medium {
        background: linear-gradient(90deg, #f59e0b, #d97706);
      }

      .chart-type-toggle {
        display: flex;
        justify-content: flex-end;
        margin-bottom: var(--space-3);
      }

      .toggle-btn-single {
        padding: var(--space-2);
        border: 1px solid var(--gray-300);
        background: white;
        cursor: pointer;
        border-radius: var(--radius-md);
        display: flex;
        align-items: center;
        justify-content: center;
        width: 36px;
        height: 36px;
        font-size: var(--text-base);
        color: var(--text-primary);
        transition: all 0.2s ease;
      }

      .toggle-btn-single:hover {
        background: var(--gray-50);
        border-color: var(--primary-500);
        color: var(--primary-600);
      }

      .toggle-btn-single .toggle-icon {
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
      }

      .toggle-btn-single .toggle-icon i {
        font-size: 18px;
        line-height: 1;
      }

      .btn-primary {
        background: var(--primary-600);
        color: white;
        border: none;
        padding: var(--space-2) var(--space-4);
        border-radius: var(--radius-md);
        cursor: pointer;
        font-weight: 500;
        transition: background var(--transition-fast);
        display: flex;
        align-items: center;
        gap: var(--space-2);
        font-size: var(--text-sm);
      }

      .btn-primary:hover {
        background: var(--primary-700);
      }

      .checkbox-filter {
        display: flex;
        align-items: center;
        gap: var(--space-2);
        margin-top: var(--space-3);
        font-size: var(--text-sm);
      }

      .checkbox-filter input[type="checkbox"] {
        width: auto;
      }

      .full-width-chart {
        grid-column: 1 / -1;
      }

      .half-width-chart {
        grid-column: span 1;
      }

      @media (min-width: 1600px) {
        .charts-grid {
          grid-template-columns: repeat(3, 1fr);
        }
      }

      @media (max-width: 1200px) {
        .charts-grid {
          grid-template-columns: 1fr;
        }
      }

      @media (max-width: 768px) {
        .dashboard-filters {
          width: 100%;
        }

        .dashboard-filters select,
        .dashboard-filters input {
          flex: 1;
        }

        .gauge-container {
          grid-template-columns: repeat(2, 1fr);
        }
      }

      /* Modal para adicionar resumo */
      .modal-overlay {
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        right: 0 !important;
        bottom: 0 !important;
        background: rgba(0, 0, 0, 0.85);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 99999 !important;
        padding: var(--space-4);
        animation: fadeIn 0.2s ease;
        overflow: hidden;
        overscroll-behavior: contain;
      }
      
      .modal-overlay.active {
        background: rgba(0, 0, 0, 0.85);
      }

      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }

      body.modal-open {
        overflow: hidden !important;
        position: fixed !important;
        width: 100% !important;
        height: 100% !important;
        top: 0 !important;
        left: 0 !important;
        right: 0 !important;
      }
      
      html.modal-open {
        overflow: hidden !important;
      }
      
      html.modal-open header,
      html.modal-open nav {
        z-index: 1 !important;
      }

      .modal-content {
        background: white;
        border-radius: var(--radius-lg);
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        max-width: 1000px;
        width: 100%;
        max-height: 85vh;
        height: 85vh;
        display: flex;
        flex-direction: column;
        animation: slideUp 0.3s ease;
        overflow: hidden;
        position: relative;
        margin: auto;
        z-index: 100000 !important;
      }

      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--space-5) var(--space-6);
        border-bottom: 1px solid var(--gray-200);
        flex-shrink: 0;
      }

      .modal-header h3 {
        margin: 0;
        font-size: var(--text-xl);
        font-weight: 600;
        color: var(--text-primary);
      }

      .modal-close {
        background: transparent;
        border: none;
        font-size: 20px;
        cursor: pointer;
        color: var(--text-secondary);
        padding: var(--space-2);
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: var(--radius-md);
        transition: all 0.2s ease;
        line-height: 1;
        outline: none;
      }

      .modal-close:focus {
        outline: 2px solid var(--primary-500);
        outline-offset: 2px;
      }

      .modal-close:hover {
        background: var(--gray-100);
        color: var(--text-primary);
      }

      .modal-body {
        display: flex;
        flex-direction: column;
        overflow: hidden;
        flex: 1 1 auto;
        min-height: 0;
        max-height: calc(85vh - 140px); /* Altura total menos header e tabs */
      }

      .modal-tabs {
        display: flex;
        border-bottom: 1px solid var(--gray-200);
        background: white;
        padding: 0;
        flex-shrink: 0;
        gap: 0;
      }

      .modal-tab {
        background: transparent;
        border: none;
        padding: var(--space-3) var(--space-5);
        cursor: pointer;
        font-size: var(--text-sm);
        font-weight: 500;
        color: var(--text-secondary);
        border-bottom: 2px solid transparent;
        transition: all 0.2s ease;
        position: relative;
        margin-bottom: -1px;
        white-space: nowrap;
        outline: none;
      }

      .modal-tab:focus {
        outline: 2px solid var(--primary-500);
        outline-offset: -2px;
        border-radius: var(--radius-sm) var(--radius-sm) 0 0;
      }

      .modal-tab:hover {
        color: var(--text-primary);
        background: var(--gray-50);
      }

      .modal-tab.active {
        color: var(--primary-600);
        border-bottom-color: var(--primary-600);
        background: white;
        font-weight: 600;
      }

      .chart-categories {
        flex: 1 1 auto;
        overflow-y: auto;
        overflow-x: hidden;
        padding: var(--space-6);
        background: var(--gray-50);
        min-height: 0;
        max-height: calc(85vh - 200px);
        overscroll-behavior: contain;
      }

      .category-section {
        display: none;
        flex-direction: column;
        gap: var(--space-4);
      }

      .category-section.active {
        display: flex;
      }

      .chart-options-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: var(--space-4);
      }

      .chart-option-card {
        background: white;
        border: 1px solid var(--gray-200);
        border-radius: var(--radius-lg);
        padding: var(--space-5);
        display: flex;
        flex-direction: column;
        gap: var(--space-4);
        transition: all 0.2s ease;
        cursor: pointer;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        outline: none;
      }

      .chart-option-card:focus {
        outline: 2px solid var(--primary-500);
        outline-offset: 2px;
      }

      .chart-option-card:hover {
        border-color: var(--primary-500);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
        transform: translateY(-2px);
      }

      .chart-option-card[style*="opacity: 0.5"] {
        cursor: not-allowed;
      }

      .chart-option-header {
        display: flex;
        align-items: flex-start;
        gap: var(--space-2);
      }

      .chart-option-header h5 {
        margin: 0;
        font-size: var(--text-base);
        font-weight: 600;
        color: var(--text-primary);
        line-height: 1.4;
        flex: 1;
      }

      .chart-option-description {
        margin: 0;
        font-size: var(--text-sm);
        color: var(--text-secondary);
        line-height: 1.6;
        flex: 1;
      }

      .chart-option-add-btn {
        background: var(--primary-600);
        color: white;
        border: none;
        padding: var(--space-2) var(--space-4);
        border-radius: var(--radius-md);
        cursor: pointer;
        font-weight: 600;
        font-size: var(--text-sm);
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--space-2);
        width: 100%;
        margin-top: auto;
      }

      .chart-option-add-btn:hover:not(:disabled) {
        background: var(--primary-700);
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
      }

      .chart-option-add-btn:disabled {
        background: var(--gray-400);
        cursor: not-allowed;
        opacity: 0.7;
      }

      @media (max-width: 1200px) {
        .charts-grid {
          grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        }
      }

      @media (max-width: 768px) {
        .charts-grid {
          grid-template-columns: 1fr;
        }

        .chart-container {
          height: 250px;
        }

        .gauge-container {
          grid-template-columns: repeat(2, 1fr);
        }

        .chart-options-grid {
          grid-template-columns: 1fr;
        }

        .modal-content {
          max-width: 100%;
          margin: var(--space-4);
          max-height: 95vh;
        }

        .modal-tabs {
          overflow-x: auto;
          -webkit-overflow-scrolling: touch;
        }

        .modal-tab {
          padding: var(--space-3) var(--space-4);
          font-size: var(--text-xs);
        }
      }

      @media (max-width: 480px) {
        .chart-container {
          height: 200px;
        }

        .charts-grid {
          grid-template-columns: 1fr;
          gap: var(--space-3);
        }
      }
    </style>
  </head>
  <body data-page="home">
    <header>
      <div class="header-left">
        <div class="header-logo">
          <span>OS</span>
        </div>
        <div class="header-brand">
          <h1><i class="ti ti-chart-line"></i> Indicadores</h1>
          <p>Visão geral das metas e desempenho</p>
        </div>
      </div>
      <div class="header-right">
        <div class="header-actions">
          <div class="header-user">
            <div class="user-avatar">A</div>
            <div class="user-info">
              <div class="user-name">Admin</div>
              <div class="user-role">Administrador</div>
            </div>
          </div>
        </div>
      </div>
    </header>

    <nav>
      <div class="nav-inner">
        <a href="index.html" data-page="home">Início</a>
        <a href="frontend/clientes.html" data-page="clientes">Clientes</a>
        <a href="frontend/orcamentos.html" data-page="orcamentos">Orçamentos</a>
        <a href="frontend/pedidos.html" data-page="pedidos">Pedidos</a>
        <a href="frontend/produtos.html" data-page="produtos">Produtos</a>
        <a href="frontend/industrias.html" data-page="industrias">Indústrias</a>
        <a href="frontend/crm.html" data-page="crm">CRM</a>
        <a href="frontend/configuracoes.html" data-page="configuracoes"><i class="ti ti-settings"></i> Mais</a>
      </div>
    </nav>

    <main>
      <div class="dashboard-container">
        <!-- Header com ações e período -->
        <div class="dashboard-header">
          <h2><i class="ti ti-chart-line"></i> Indicadores</h2>
          <div class="dashboard-actions">
            <div class="period-filter">
              <input type="date" id="dataInicio" class="date-input" />
              <span class="date-separator">até</span>
              <input type="date" id="dataFim" class="date-input" />
              <button class="btn-filter-ok" id="confirmarFiltroBtn" title="Aplicar filtro" type="button">
                OK
              </button>
            </div>
            <button class="btn-primary" id="addSummaryBtn">
              <i class="ti ti-plus"></i> Adicionar Resumo
            </button>
          </div>
        </div>

        <!-- Grid de Gráficos -->
        <div class="charts-grid" id="chartsGrid">
          <!-- Os gráficos serão adicionados dinamicamente aqui -->
        </div>
      </div>
    </main>

    <!-- Modal para adicionar resumo -->
    <div class="modal-overlay" id="addSummaryModal" style="display: none;">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Adicionar Resumo</h3>
          <button class="modal-close" id="closeSummaryModal">✕</button>
        </div>
        <div class="modal-body">
          <div class="modal-tabs">
            <button class="modal-tab active" data-category="clientes">Clientes</button>
            <button class="modal-tab" data-category="financeiro">Financeiro</button>
            <button class="modal-tab" data-category="pedidos">Pedidos</button>
            <button class="modal-tab" data-category="outros">Outros</button>
          </div>
          
          <div class="chart-categories">
            <!-- Categoria Clientes -->
            <div class="category-section active" data-category="clientes">
              <div class="chart-options-grid">
                <div class="chart-option-card" data-chart="clientesMaisRentaveis">
                  <div class="chart-option-header">
                    <h5>Clientes mais rentáveis</h5>
                  </div>
                  <p class="chart-option-description">
                    Listagem de clientes mais rentáveis baseado no volume de vendas durante o período definido no filtro.
                  </p>
                  <button class="chart-option-add-btn">Adicionar</button>
                </div>
                
                <div class="chart-option-card" data-chart="clientesDiasSemComprar">
                  <div class="chart-option-header">
                    <h5>Clientes - Dias sem comprar</h5>
                  </div>
                  <p class="chart-option-description">
                    Listagem de clientes que estão a mais dias sem comprar durante o período definido no filtro.
                  </p>
                  <button class="chart-option-add-btn">Adicionar</button>
                </div>
                
                <div class="chart-option-card" data-chart="clientesMenosRentaveis">
                  <div class="chart-option-header">
                    <h5>Clientes menos rentáveis</h5>
                  </div>
                  <p class="chart-option-description">
                    Listagem de clientes menos rentáveis baseado no volume de vendas durante o período definido no filtro.
                  </p>
                  <button class="chart-option-add-btn">Adicionar</button>
                </div>
                
                <div class="chart-option-card" data-chart="rankingClientes">
                  <div class="chart-option-header">
                    <h5>Ranking de Clientes</h5>
                  </div>
                  <p class="chart-option-description">
                    Ranking de clientes por vendas realizadas durante o período filtrado. Pode ser agrupado por Matriz.
                  </p>
                  <button class="chart-option-add-btn">Adicionar</button>
                </div>
              </div>
            </div>
            
            <!-- Categoria Financeiro -->
            <div class="category-section" data-category="financeiro" style="display: none;">
              <div class="chart-options-grid">
                <div class="chart-option-card" data-chart="despesasPorGrupoContas">
                  <div class="chart-option-header">
                    <h5>Despesas por Grupo de Contas (Gráfico)</h5>
                  </div>
                  <p class="chart-option-description">
                    Gráfico de Despesas agrupadas por Grupo de Contas durante o período definido no filtro.
                  </p>
                  <button class="chart-option-add-btn">Adicionar</button>
                </div>
                
                <div class="chart-option-card" data-chart="receitasPorGrupoContas">
                  <div class="chart-option-header">
                    <h5>Receitas por Grupo de Contas (Gráfico)</h5>
                  </div>
                  <p class="chart-option-description">
                    Gráfico de Receitas agrupadas por Grupo de Contas durante o período definido no filtro.
                  </p>
                  <button class="chart-option-add-btn">Adicionar</button>
                </div>
                
                <div class="chart-option-card" data-chart="receitasXDespesas">
                  <div class="chart-option-header">
                    <h5>Receitas x Despesas (Gráfico)</h5>
                  </div>
                  <p class="chart-option-description">
                    Gráfico com o comparativo de Receitas e Despesas durante o período definido no filtro.
                  </p>
                  <button class="chart-option-add-btn">Adicionar</button>
                </div>
                
                <div class="chart-option-card" data-chart="receitasPorContaBancaria">
                  <div class="chart-option-header">
                    <h5>Receitas por conta bancária (Gráfico)</h5>
                  </div>
                  <p class="chart-option-description">
                    Gráfico de Receitas separadas por Contas Bancárias durante o período definido no filtro.
                  </p>
                  <button class="chart-option-add-btn">Adicionar</button>
                </div>
                
                <div class="chart-option-card" data-chart="despesasPorContaBancaria">
                  <div class="chart-option-header">
                    <h5>Despesas por conta bancária (Gráfico)</h5>
                  </div>
                  <p class="chart-option-description">
                    Gráfico de Despesas separadas por Contas Bancárias durante o período definido no filtro.
                  </p>
                  <button class="chart-option-add-btn">Adicionar</button>
                </div>
                
                <div class="chart-option-card" data-chart="despesasNaoLiquidadas">
                  <div class="chart-option-header">
                    <h5>Despesas não liquidadas</h5>
                  </div>
                  <p class="chart-option-description">
                    Listagem das últimas Despesas não liquidadas, limitado a 5 lançamentos por status.
                  </p>
                  <button class="chart-option-add-btn">Adicionar</button>
                </div>
                
                <div class="chart-option-card" data-chart="receitasNaoLiquidadas">
                  <div class="chart-option-header">
                    <h5>Receitas não liquidadas</h5>
                  </div>
                  <p class="chart-option-description">
                    Listagem das últimas Receitas não liquidadas, limitado a 5 lançamentos por status.
                  </p>
                  <button class="chart-option-add-btn">Adicionar</button>
                </div>
              </div>
            </div>
            
            <!-- Categoria Pedidos -->
            <div class="category-section" data-category="pedidos" style="display: none;">
              <div class="chart-options-grid">
                <p style="color: var(--text-secondary); padding: var(--space-4); text-align: center;">
                  Gráficos de pedidos em desenvolvimento
                </p>
              </div>
            </div>
            
            <!-- Categoria Outros -->
            <div class="category-section" data-category="outros" style="display: none;">
              <div class="chart-options-grid">
                <p style="color: var(--text-secondary); padding: var(--space-4); text-align: center;">
                  Outros gráficos em desenvolvimento
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <footer>
      OurSales • Sistema de Gestão Comercial • Desenvolvido para otimizar sua
      operação
    </footer>

    <script src="frontend/assets/js/api.js"></script>
    <script src="frontend/assets/js/input-masks.js"></script>
    <script src="frontend/assets/js/scroll-optimization.js" defer></script>
    <script src="frontend/assets/js/disable-animations.js" defer></script>
    <script src="frontend/assets/js/oursales-fixes.js" defer></script>
    <script src="frontend/assets/js/app.js" defer></script>
    <script src="frontend/assets/js/version-check.js" defer></script>
    <script>
      // Dashboard JavaScript
      (function () {
        const API = window.oursalesAPI || {
          getIndustrias: () => Promise.resolve({ data: [] }),
          getDashboardStats: () => Promise.resolve({ data: {} }),
          getVendasPorPeriodo: () => Promise.resolve([]),
          getVendasPorVendedor: () => Promise.resolve([]),
          getVendasPorCliente: () => Promise.resolve([]),
          getVendasPorIndustria: () => Promise.resolve([]),
          getTopProdutos: () => Promise.resolve([]),
        };

        let charts = {};
        let activeCharts = new Set([]); // Sem gráficos padrão
        let industrias = [];
        let filters = {
          industriaId: null,
          dataInicio: null,
          dataFim: null,
        };

        // Tipos de gráficos disponíveis
        const chartTypes = {
          // Gráficos de Clientes
          clientesMaisRentaveis: {
            title: 'Clientes mais rentáveis',
            type: 'bar',
            supportsToggle: true,
            defaultView: 'bar',
            category: 'clientes',
            fetchData: async () => {
              // Buscar clientes mais rentáveis
              try {
                const response = await API.getVendasPorCliente(filters);
                const data = Array.isArray(response) ? response : (response.data || []);
                return data
                  .sort((a, b) => (b.valor || 0) - (a.valor || 0))
                  .slice(0, 10)
                  .map(item => ({
                    nome: item.clienteNome || item.nome || 'Cliente',
                    valor: item.valor || 0,
                    percentual: 0,
                  }));
              } catch (error) {
                console.error('Erro ao buscar clientes mais rentáveis:', error);
                return [];
              }
            },
          },
          clientesMenosRentaveis: {
            title: 'Clientes menos rentáveis',
            type: 'bar',
            supportsToggle: true,
            defaultView: 'bar',
            category: 'clientes',
            fetchData: async () => {
              // Buscar clientes menos rentáveis
              try {
                const response = await API.getVendasPorCliente(filters);
                const data = Array.isArray(response) ? response : (response.data || []);
                return data
                  .sort((a, b) => (a.valor || 0) - (b.valor || 0))
                  .slice(0, 10)
                  .map(item => ({
                    nome: item.clienteNome || item.nome || 'Cliente',
                    valor: item.valor || 0,
                    percentual: 0,
                  }));
              } catch (error) {
                console.error('Erro ao buscar clientes menos rentáveis:', error);
                return [];
              }
            },
          },
          clientesDiasSemComprar: {
            title: 'Clientes - Dias sem comprar',
            type: 'bar',
            supportsToggle: true,
            defaultView: 'bar',
            category: 'clientes',
            fetchData: async () => {
              // Buscar clientes com mais dias sem comprar
              try {
                const response = await API.getVendasPorCliente(filters);
                const data = Array.isArray(response) ? response : (response.data || []);
                const hoje = new Date();
                return data
                  .map(item => {
                    const ultimaCompra = item.ultimaCompra ? new Date(item.ultimaCompra) : null;
                    const diasSemComprar = ultimaCompra 
                      ? Math.floor((hoje - ultimaCompra) / (1000 * 60 * 60 * 24))
                      : 999;
                    return {
                      nome: item.clienteNome || item.nome || 'Cliente',
                      dias: diasSemComprar,
                      valor: diasSemComprar,
                      percentual: 0,
                    };
                  })
                  .sort((a, b) => b.dias - a.dias)
                  .slice(0, 10);
              } catch (error) {
                console.error('Erro ao buscar clientes sem comprar:', error);
                return [];
              }
            },
          },
          rankingClientes: {
            title: 'Ranking de Clientes',
            type: 'bar',
            supportsToggle: true,
            defaultView: 'bar',
            category: 'clientes',
            supportsGrouping: true, // Pode ser agrupado por Matriz
            fetchData: async () => {
              // Buscar ranking de clientes
              try {
                const response = await API.getVendasPorCliente(filters);
                const data = Array.isArray(response) ? response : (response.data || []);
                return data
                  .sort((a, b) => (b.valor || 0) - (a.valor || 0))
                  .map((item, index) => ({
                    nome: item.clienteNome || item.nome || 'Cliente',
                    valor: item.valor || 0,
                    posicao: index + 1,
                    percentual: 0,
                  }));
              } catch (error) {
                console.error('Erro ao buscar ranking de clientes:', error);
                return [];
              }
            },
          },
          // Gráficos Financeiros
          despesasPorGrupoContas: {
            title: 'Despesas por Grupo de Contas',
            type: 'bar',
            supportsToggle: true,
            defaultView: 'pie', // Pizza é melhor para distribuição
            category: 'financeiro',
            fetchData: async () => {
              // Buscar despesas por grupo de contas
              try {
                // TODO: Implementar endpoint no backend
                // const response = await API.getDespesasPorGrupoContas(filters);
                // return response.data || [];
                return [
                  { nome: 'Fornecedores', valor: 15000 },
                  { nome: 'Salários', valor: 25000 },
                  { nome: 'Impostos', valor: 8000 },
                  { nome: 'Aluguel', valor: 5000 },
                  { nome: 'Outros', valor: 3000 },
                ];
              } catch (error) {
                console.error('Erro ao buscar despesas por grupo de contas:', error);
                return [];
              }
            },
          },
          receitasPorGrupoContas: {
            title: 'Receitas por Grupo de Contas',
            type: 'bar',
            supportsToggle: true,
            defaultView: 'pie', // Pizza é melhor para distribuição
            category: 'financeiro',
            fetchData: async () => {
              // Buscar receitas por grupo de contas
              try {
                // TODO: Implementar endpoint no backend
                // const response = await API.getReceitasPorGrupoContas(filters);
                // return response.data || [];
                return [
                  { nome: 'Vendas', valor: 80000 },
                  { nome: 'Serviços', valor: 20000 },
                  { nome: 'Juros', valor: 1000 },
                  { nome: 'Outros', valor: 2000 },
                ];
              } catch (error) {
                console.error('Erro ao buscar receitas por grupo de contas:', error);
                return [];
              }
            },
          },
          receitasXDespesas: {
            title: 'Receitas x Despesas',
            type: 'line', // Gráfico de linha para comparação temporal
            supportsToggle: true,
            defaultView: 'bar', // Pode alternar para barra agrupada
            category: 'financeiro',
            fetchData: async () => {
              // Buscar receitas e despesas comparativas
              try {
                // TODO: Implementar endpoint no backend
                // const response = await API.getReceitasXDespesas(filters);
                // return response.data || [];
                return {
                  labels: ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun'],
                  receitas: [80000, 85000, 90000, 88000, 92000, 95000],
                  despesas: [60000, 62000, 65000, 63000, 64000, 66000],
                };
              } catch (error) {
                console.error('Erro ao buscar receitas x despesas:', error);
                return { labels: [], receitas: [], despesas: [] };
              }
            },
          },
          receitasPorContaBancaria: {
            title: 'Receitas por Conta Bancária',
            type: 'bar',
            supportsToggle: true,
            defaultView: 'pie', // Pizza para distribuição
            category: 'financeiro',
            fetchData: async () => {
              // Buscar receitas por conta bancária
              try {
                // TODO: Implementar endpoint no backend
                // const response = await API.getReceitasPorContaBancaria(filters);
                // return response.data || [];
                return [
                  { nome: 'Conta Corrente', valor: 70000 },
                  { nome: 'Poupança', valor: 20000 },
                  { nome: 'Investimentos', valor: 10000 },
                ];
              } catch (error) {
                console.error('Erro ao buscar receitas por conta bancária:', error);
                return [];
              }
            },
          },
          despesasPorContaBancaria: {
            title: 'Despesas por Conta Bancária',
            type: 'bar',
            supportsToggle: true,
            defaultView: 'pie', // Pizza para distribuição
            category: 'financeiro',
            fetchData: async () => {
              // Buscar despesas por conta bancária
              try {
                // TODO: Implementar endpoint no backend
                // const response = await API.getDespesasPorContaBancaria(filters);
                // return response.data || [];
                return [
                  { nome: 'Conta Corrente', valor: 50000 },
                  { nome: 'Poupança', valor: 10000 },
                  { nome: 'Cartão de Crédito', valor: 5000 },
                ];
              } catch (error) {
                console.error('Erro ao buscar despesas por conta bancária:', error);
                return [];
              }
            },
          },
          despesasNaoLiquidadas: {
            title: 'Despesas não liquidadas',
            type: 'table', // Listagem em tabela
            supportsToggle: false,
            category: 'financeiro',
            fetchData: async () => {
              // Buscar despesas não liquidadas
              try {
                // TODO: Implementar endpoint no backend
                // const response = await API.getDespesasNaoLiquidadas(filters);
                // return response.data || [];
                return [
                  { descricao: 'Fornecedor ABC', valor: 5000, vencimento: '2024-01-15', status: 'Pendente' },
                  { descricao: 'Aluguel', valor: 3000, vencimento: '2024-01-10', status: 'Vencido' },
                  { descricao: 'Impostos', valor: 2000, vencimento: '2024-01-20', status: 'Pendente' },
                ];
              } catch (error) {
                console.error('Erro ao buscar despesas não liquidadas:', error);
                return [];
              }
            },
          },
          receitasNaoLiquidadas: {
            title: 'Receitas não liquidadas',
            type: 'table', // Listagem em tabela
            supportsToggle: false,
            category: 'financeiro',
            fetchData: async () => {
              // Buscar receitas não liquidadas
              try {
                // TODO: Implementar endpoint no backend
                // const response = await API.getReceitasNaoLiquidadas(filters);
                // return response.data || [];
                return [
                  { descricao: 'Cliente XYZ', valor: 15000, vencimento: '2024-01-12', status: 'Pendente' },
                  { descricao: 'Serviço ABC', valor: 8000, vencimento: '2024-01-18', status: 'Pendente' },
                  { descricao: 'Venda 123', valor: 5000, vencimento: '2024-01-25', status: 'Aguardando' },
                ];
              } catch (error) {
                console.error('Erro ao buscar receitas não liquidadas:', error);
                return [];
              }
            },
          },
        };

        // Carregar indústrias
        async function loadIndustrias() {
          try {
            const response = await API.getIndustrias();
            industrias = Array.isArray(response) ? response : (response.data || []);
            
            // Atualizar selects de indústria
            document.querySelectorAll('.industria-filter').forEach(select => {
              const currentValue = select.value;
              select.innerHTML = '<option value="">Todas as Indústrias</option>';
              industrias.forEach(industria => {
                const option = document.createElement('option');
                option.value = industria.id;
                option.textContent = industria.razaoSocial || industria.nomeFantasia || industria.nome;
                if (option.value === currentValue) {
                  option.selected = true;
                }
                select.appendChild(option);
              });
            });
          } catch (error) {
            console.error('Erro ao carregar indústrias:', error);
          }
        }

        // Criar gráfico de gauge
        function createGaugeChart(canvasId, value, label, maxValue = 100) {
          const canvas = document.getElementById(canvasId);
          if (!canvas) return null;

          const ctx = canvas.getContext('2d');
          
          // Destruir gráfico existente
          if (charts[canvasId]) {
            charts[canvasId].destroy();
          }

          const percent = Math.min((value / maxValue) * 100, 100);
          
          charts[canvasId] = new Chart(ctx, {
            type: 'doughnut',
            data: {
              datasets: [{
                data: [percent, 100 - percent],
                backgroundColor: [
                  percent >= 80 ? '#10b981' : percent >= 50 ? '#f59e0b' : '#ef4444',
                  '#e5e7eb'
                ],
                borderWidth: 0,
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              cutout: '75%',
              plugins: {
                legend: { display: false },
                tooltip: { enabled: false },
              },
            },
            plugins: [{
              id: 'gaugeText',
              beforeDraw: (chart) => {
                const ctx = chart.ctx;
                const centerX = chart.chartArea.left + (chart.chartArea.right - chart.chartArea.left) / 2;
                const centerY = chart.chartArea.top + (chart.chartArea.bottom - chart.chartArea.top) / 2;
                
                ctx.save();
                ctx.font = 'bold 24px Arial';
                ctx.fillStyle = '#1f2937';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(value.toFixed(0), centerX, centerY - 10);
                
                ctx.font = '12px Arial';
                ctx.fillStyle = '#6b7280';
                ctx.fillText(label, centerX, centerY + 15);
                ctx.restore();
              }
            }]
          });

          return charts[canvasId];
        }

        // Criar gráfico de barras horizontais
        function createBarChart(canvasId, data, chartConfig) {
          const canvas = document.getElementById(canvasId);
          if (!canvas) return null;

          const ctx = canvas.getContext('2d');
          
          if (charts[canvasId]) {
            charts[canvasId].destroy();
          }

          // Determinar se é percentual ou valor monetário
          const isPercentual = data.length > 0 && data[0].percentual !== undefined && data[0].percentual !== null;
          const isDias = data.length > 0 && data[0].dias !== undefined;
          const isValor = data.length > 0 && data[0].valor !== undefined && !isPercentual && !isDias;

          const chartData = data.map(d => {
            if (isPercentual) return d.percentual || 0;
            if (isDias) return d.dias || 0;
            return d.valor || 0;
          });

          const maxValue = isPercentual ? 100 : Math.max(...chartData, 1);

          charts[canvasId] = new Chart(ctx, {
            type: 'bar',
            data: {
              labels: data.map(d => d.nome),
              datasets: [{
                label: isPercentual ? 'Percentual' : isDias ? 'Dias' : 'Valor',
                data: chartData,
                backgroundColor: chartData.map(val => {
                  if (isPercentual) {
                    return val >= 80 ? 'rgba(16, 185, 129, 0.8)' :
                           val >= 50 ? 'rgba(245, 158, 11, 0.8)' :
                           'rgba(239, 68, 68, 0.8)';
                  }
                  return 'rgba(59, 130, 246, 0.8)';
                }),
                borderColor: chartData.map(val => {
                  if (isPercentual) {
                    return val >= 80 ? '#10b981' :
                           val >= 50 ? '#f59e0b' :
                           '#ef4444';
                  }
                  return '#3b82f6';
                }),
                borderWidth: 1,
              }]
            },
            options: {
              indexAxis: 'y',
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { display: false },
                tooltip: {
                  callbacks: {
                    label: (context) => {
                      const value = context.parsed.x;
                      if (isPercentual) return `${value.toFixed(2)}%`;
                      if (isDias) return `${value} dias`;
                      return formatCurrency(value);
                    }
                  }
                }
              },
              scales: {
                x: {
                  beginAtZero: true,
                  max: isPercentual ? 100 : undefined,
                  ticks: {
                    callback: (value) => {
                      if (isPercentual) return `${value}%`;
                      if (isDias) return `${value} dias`;
                      return formatCurrency(value);
                    }
                  }
                }
              }
            }
          });

          return charts[canvasId];
        }

        // Criar gráfico de pizza
        function createPieChart(canvasId, data) {
          const canvas = document.getElementById(canvasId);
          if (!canvas) return null;

          const ctx = canvas.getContext('2d');
          
          if (charts[canvasId]) {
            charts[canvasId].destroy();
          }

          // Verificar se há dados
          if (!data || data.length === 0) {
            console.warn(`Sem dados para o gráfico ${canvasId}`);
            return null;
          }

          // Determinar se usa valor ou percentual
          const isPercentual = data.length > 0 && data[0].percentual !== undefined && data[0].percentual !== null;
          const chartData = data.map(d => isPercentual ? (d.percentual || 0) : (d.valor || 0));

          // Verificar se há valores válidos
          const total = chartData.reduce((sum, val) => sum + (val || 0), 0);
          if (total === 0) {
            console.warn(`Todos os valores são zero para o gráfico ${canvasId}`);
            return null;
          }

          charts[canvasId] = new Chart(ctx, {
            type: 'doughnut',
            data: {
              labels: data.map(d => d.nome),
              datasets: [{
                data: chartData,
                backgroundColor: generateColors(data.length),
                borderColor: 'white',
                borderWidth: 2,
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              layout: {
                padding: {
                  right: 10,
                }
              },
              plugins: {
                legend: {
                  position: 'bottom',
                  align: 'center',
                  labels: {
                    boxWidth: 12,
                    padding: 8,
                    font: {
                      size: 11
                    },
                    usePointStyle: true,
                    maxWidth: 200,
                  }
                },
                tooltip: {
                  callbacks: {
                    label: (context) => {
                      const label = context.label || '';
                      const value = context.parsed;
                      if (isPercentual) return `${label}: ${value.toFixed(2)}%`;
                      return `${label}: ${formatCurrency(value)}`;
                    }
                  }
                }
              }
            }
          });

          return charts[canvasId];
        }

        // Criar gráfico de linha (para comparação temporal)
        function createLineChart(canvasId, data) {
          const canvas = document.getElementById(canvasId);
          if (!canvas) return null;

          const ctx = canvas.getContext('2d');
          
          if (charts[canvasId]) {
            charts[canvasId].destroy();
          }

          charts[canvasId] = new Chart(ctx, {
            type: 'line',
            data: {
              labels: data.labels || [],
              datasets: [
                {
                  label: 'Receitas',
                  data: data.receitas || [],
                  borderColor: 'rgba(16, 185, 129, 1)',
                  backgroundColor: 'rgba(16, 185, 129, 0.1)',
                  tension: 0.4,
                  fill: true,
                },
                {
                  label: 'Despesas',
                  data: data.despesas || [],
                  borderColor: 'rgba(239, 68, 68, 1)',
                  backgroundColor: 'rgba(239, 68, 68, 0.1)',
                  tension: 0.4,
                  fill: true,
                }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  position: 'top',
                },
                tooltip: {
                  callbacks: {
                    label: (context) => {
                      return `${context.dataset.label}: ${formatCurrency(context.parsed.y)}`;
                    }
                  }
                }
              },
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: {
                    callback: (value) => formatCurrency(value)
                  }
                }
              }
            }
          });

          return charts[canvasId];
        }

        // Criar gráfico de barra agrupada (para comparação)
        function createGroupedBarChart(canvasId, data) {
          const canvas = document.getElementById(canvasId);
          if (!canvas) return null;

          const ctx = canvas.getContext('2d');
          
          if (charts[canvasId]) {
            charts[canvasId].destroy();
          }

          charts[canvasId] = new Chart(ctx, {
            type: 'bar',
            data: {
              labels: data.labels || [],
              datasets: [
                {
                  label: 'Receitas',
                  data: data.receitas || [],
                  backgroundColor: 'rgba(16, 185, 129, 0.8)',
                  borderColor: 'rgba(16, 185, 129, 1)',
                  borderWidth: 1,
                },
                {
                  label: 'Despesas',
                  data: data.despesas || [],
                  backgroundColor: 'rgba(239, 68, 68, 0.8)',
                  borderColor: 'rgba(239, 68, 68, 1)',
                  borderWidth: 1,
                }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  position: 'top',
                },
                tooltip: {
                  callbacks: {
                    label: (context) => {
                      return `${context.dataset.label}: ${formatCurrency(context.parsed.y)}`;
                    }
                  }
                }
              },
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: {
                    callback: (value) => formatCurrency(value)
                  }
                }
              }
            }
          });

          return charts[canvasId];
        }

        // Criar tabela (para listagens)
        function createTable(containerId, data, title) {
          const container = document.getElementById(containerId);
          if (!container) return null;

          // Remover tabela anterior se existir
          const existingTable = container.querySelector('.data-table');
          if (existingTable) {
            existingTable.remove();
          }

          const tableContainer = document.createElement('div');
          tableContainer.className = 'data-table';
          tableContainer.style.padding = 'var(--space-4)';

          if (data.length === 0) {
            tableContainer.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">Nenhum dado disponível</p>';
            container.appendChild(tableContainer);
            return;
          }

          let tableHTML = '<table style="width: 100%; border-collapse: collapse;">';
          tableHTML += '<thead><tr style="background: var(--gray-100); border-bottom: 2px solid var(--gray-300);">';
          
          // Cabeçalhos baseados nas chaves do primeiro item
          const keys = Object.keys(data[0]);
          keys.forEach(key => {
            if (key !== 'id') {
              const header = key.charAt(0).toUpperCase() + key.slice(1).replace(/([A-Z])/g, ' $1');
              tableHTML += `<th style="padding: var(--space-3); text-align: left; font-weight: 600; color: var(--text-primary);">${header}</th>`;
            }
          });
          tableHTML += '</tr></thead><tbody>';

          data.forEach((row, index) => {
            tableHTML += `<tr style="border-bottom: 1px solid var(--gray-200); ${index % 2 === 0 ? 'background: white;' : 'background: var(--gray-50);'}">`;
            keys.forEach(key => {
              if (key !== 'id') {
                let value = row[key];
                if (key === 'valor') {
                  value = formatCurrency(value);
                } else if (key === 'vencimento') {
                  value = new Date(value).toLocaleDateString('pt-BR');
                } else if (key === 'status') {
                  const statusColors = {
                    'Pendente': 'var(--amber-500)',
                    'Vencido': 'var(--rose-500)',
                    'Aguardando': 'var(--primary-500)',
                  };
                  const color = statusColors[value] || 'var(--text-secondary)';
                  value = `<span style="color: ${color}; font-weight: 600;">${value}</span>`;
                }
                tableHTML += `<td style="padding: var(--space-3); color: var(--text-primary);">${value}</td>`;
              }
            });
            tableHTML += '</tr>';
          });

          tableHTML += '</tbody></table>';
          tableContainer.innerHTML = tableHTML;
          container.appendChild(tableContainer);
        }

        // Adicionar card de gráfico
        function addChartCard(chartId, chartConfig) {
          const grid = document.getElementById('chartsGrid');
          const card = document.createElement('div');
          card.className = 'chart-card';
          card.id = `chart-${chartId}`;
          
          const isGauge = chartConfig.type === 'gauge';

          let chartContent = '';
          
          if (isGauge) {
            chartContent = `
              <div class="chart-card-filter">
                <select class="industria-filter" data-chart="${chartId}">
                  <option value="">Todas as Indústrias</option>
                </select>
              </div>
              <div class="gauge-container">
                <div class="gauge-item">
                  <canvas id="gauge-${chartId}-mes"></canvas>
                  <div class="gauge-label">Mês Atual %</div>
                  <div class="gauge-value" id="value-${chartId}-mes">0</div>
                </div>
                <div class="gauge-item">
                  <canvas id="gauge-${chartId}-trim"></canvas>
                  <div class="gauge-label">Trimestral %</div>
                  <div class="gauge-value" id="value-${chartId}-trim">0</div>
                </div>
                <div class="gauge-item">
                  <canvas id="gauge-${chartId}-sem"></canvas>
                  <div class="gauge-label">Semestral %</div>
                  <div class="gauge-value" id="value-${chartId}-sem">0</div>
                </div>
                <div class="gauge-item">
                  <canvas id="gauge-${chartId}-ano"></canvas>
                  <div class="gauge-label">Anual %</div>
                  <div class="gauge-value" id="value-${chartId}-ano">0</div>
                </div>
              </div>
            `;
          } else if (chartConfig.type === 'table') {
            // Tabela não precisa de canvas, será renderizada diretamente
            chartContent = `
              <div class="chart-container" id="table-container-${chartId}">
                <!-- Tabela será inserida aqui -->
              </div>
            `;
          } else {
            // Botão único para alternar entre barra/pizza/linha
            const getIconForView = (view) => {
              if (view === 'pie') return '<i class="ti ti-chart-pie"></i>';
              if (view === 'line') return '<i class="ti ti-chart-line"></i>';
              return '<i class="ti ti-chart-bar"></i>';
            };
            const getTextForView = (view) => {
              if (view === 'pie') return 'Pizza';
              if (view === 'line') return 'Linha';
              return 'Barra';
            };
            const defaultView = chartConfig.defaultView || 'bar';
            const toggleButton = chartConfig.supportsToggle ? `
              <div class="chart-type-toggle">
                <button class="toggle-btn-single" data-chart="${chartId}" title="Alternar tipo de gráfico">
                  <span class="toggle-icon">${getIconForView(defaultView)}</span>
                </button>
              </div>
            ` : '';
            
            // Verificar se precisa de filtro por indústria
            const needsIndustriaFilter = chartConfig.category === 'clientes' || chartConfig.supportsGrouping;
            const industriaFilter = needsIndustriaFilter ? `
              <div class="chart-card-filter">
                <select class="industria-filter" data-chart="${chartId}">
                  <option value="">Todas as Indústrias</option>
                </select>
              </div>
            ` : '';
            
            // Verificar se precisa de checkbox (apenas para alguns gráficos)
            const needsCheckbox = chartId === 'metaVendedoresMes';
            const checkboxFilter = needsCheckbox ? `
              <div class="checkbox-filter">
                <input type="checkbox" id="showZero-${chartId}" data-chart="${chartId}" checked>
                <label for="showZero-${chartId}">Exibir Vendedores Sem Vendas</label>
              </div>
            ` : '';
            
            chartContent = `
              ${industriaFilter}
              ${toggleButton}
              ${checkboxFilter}
              <div class="chart-container">
                <canvas id="canvas-${chartId}"></canvas>
              </div>
            `;
          }

          card.innerHTML = `
            <div class="chart-card-header">
              <div class="chart-card-title">${chartConfig.title}</div>
              <div class="chart-card-actions">
                <button onclick="removeChart('${chartId}')" title="Remover gráfico">✕</button>
              </div>
            </div>
            ${chartContent}
          `;
          
          grid.appendChild(card);
          
          // Adicionar event listeners para botão de toggle único
          if (!isGauge && chartConfig.supportsToggle && chartConfig.type !== 'table') {
            const toggleBtn = card.querySelector('.toggle-btn-single');
            if (toggleBtn) {
              toggleBtn.addEventListener('click', () => {
                const currentView = chartConfig.currentView || chartConfig.defaultView || 'bar';
                let nextView;
                
                // Lógica de alternância baseada no tipo de gráfico
                if (chartConfig.type === 'line') {
                  // Para gráficos de linha: alterna entre linha e barra agrupada
                  nextView = currentView === 'line' ? 'bar' : 'line';
                } else {
                  // Para outros gráficos: alterna entre barra e pizza
                  nextView = currentView === 'bar' ? 'pie' : 'bar';
                }
                
                chartConfig.currentView = nextView;
                
                // Atualizar ícone do botão
                const icon = toggleBtn.querySelector('.toggle-icon');
                if (nextView === 'pie') {
                  icon.innerHTML = '<i class="ti ti-chart-pie"></i>';
                } else if (nextView === 'line') {
                  icon.innerHTML = '<i class="ti ti-chart-line"></i>';
                } else {
                  icon.innerHTML = '<i class="ti ti-chart-bar"></i>';
                }
                
                loadChart(chartId);
              });
            }
          }
          
          card.querySelectorAll('.industria-filter').forEach(select => {
            select.addEventListener('change', (e) => {
              filters.industriaId = e.target.value || null;
              loadChart(chartId);
            });
          });
        }

        // Carregar gráfico
        async function loadChart(chartId) {
          const chartConfig = chartTypes[chartId];
          if (!chartConfig) return;

          const container = document.getElementById(`chart-${chartId}`);
          if (!container) {
            addChartCard(chartId, chartConfig);
            // Aguardar um pouco para o DOM atualizar
            await new Promise(resolve => setTimeout(resolve, 100));
          }

          try {
            const data = await chartConfig.fetchData();

            if (chartConfig.type === 'gauge') {
              // Criar 4 gauges
              createGaugeChart(`gauge-${chartId}-mes`, data.mesAtual || 0, 'Mês Atual', 100);
              createGaugeChart(`gauge-${chartId}-trim`, data.trimestral || 0, 'Trimestral', 100);
              createGaugeChart(`gauge-${chartId}-sem`, data.semestral || 0, 'Semestral', 100);
              createGaugeChart(`gauge-${chartId}-ano`, data.anual || 0, 'Anual', 100);
              
              // Atualizar valores
              document.getElementById(`value-${chartId}-mes`).textContent = (data.mesAtual || 0).toFixed(0);
              document.getElementById(`value-${chartId}-trim`).textContent = (data.trimestral || 0).toFixed(0);
              document.getElementById(`value-${chartId}-sem`).textContent = (data.semestral || 0).toFixed(0);
              document.getElementById(`value-${chartId}-ano`).textContent = (data.anual || 0).toFixed(0);
            } else if (chartConfig.type === 'line') {
              // Gráfico de linha (comparação temporal)
              const currentView = chartConfig.currentView || chartConfig.defaultView || 'line';
              if (currentView === 'line') {
                createLineChart(`canvas-${chartId}`, data);
              } else {
                createGroupedBarChart(`canvas-${chartId}`, data);
              }
            } else if (chartConfig.type === 'table') {
              // Tabela (listagem) - não usa canvas
              const container = document.getElementById(`chart-${chartId}`);
              if (container) {
                // Remover canvas se existir
                const canvas = container.querySelector('canvas');
                if (canvas) {
                  canvas.remove();
                }
                createTable(`table-container-${chartId}`, data, chartConfig.title);
              }
            } else {
              // Gráficos de barra/pizza (bar, pie)
              const currentView = chartConfig.currentView || chartConfig.defaultView || 'bar';
              // Filtrar dados baseado no tipo de gráfico
              let filteredData = data;
              
              // Aplicar filtro de "Exibir Sem Vendas" apenas para gráficos que têm esse checkbox
              const showZeroCheckbox = document.getElementById(`showZero-${chartId}`);
              if (showZeroCheckbox) {
                const showZero = showZeroCheckbox.checked;
                if (!showZero) {
                  filteredData = data.filter(d => {
                    // Para gráficos de percentual, filtrar por percentual > 0
                    if (d.percentual !== undefined) return d.percentual > 0;
                    // Para gráficos de valor, filtrar por valor > 0
                    if (d.valor !== undefined) return d.valor > 0;
                    // Para gráficos de dias, filtrar por dias > 0
                    if (d.dias !== undefined) return d.dias > 0;
                    return true;
                  });
                }
              }

              if (currentView === 'bar') {
                createBarChart(`canvas-${chartId}`, filteredData, chartConfig);
              } else if (currentView === 'pie') {
                createPieChart(`canvas-${chartId}`, filteredData);
              }
            }
          } catch (error) {
            console.error(`Erro ao carregar gráfico ${chartId}:`, error);
          }
        }

        // Carregar todos os gráficos
        async function loadAllCharts() {
          await Promise.all(Array.from(activeCharts).map(id => loadChart(id)));
        }

        // Remover gráfico
        window.removeChart = function(chartId) {
          // Destruir todos os charts relacionados
          Object.keys(charts).forEach(key => {
            if (key.startsWith(`gauge-${chartId}-`) || key === `canvas-${chartId}`) {
              charts[key].destroy();
              delete charts[key];
            }
          });
          
          activeCharts.delete(chartId);
          const card = document.getElementById(`chart-${chartId}`);
          if (card) {
            card.remove();
          }
          saveChartPreferences();
        };

        // Atualizar filtros de data
        function updateDateFilters() {
          const inicio = document.getElementById('dataInicio').value;
          const fim = document.getElementById('dataFim').value;
          
          filters.dataInicio = inicio || null;
          filters.dataFim = fim || null;
          
          loadAllCharts();
        }

        // Aplicar filtro de data padrão (3 meses atrás até hoje)
        function applyDefaultDateFilter() {
          const hoje = new Date();
          const tresMesesAtras = new Date();
          tresMesesAtras.setMonth(hoje.getMonth() - 3);
          
          document.getElementById('dataInicio').value = tresMesesAtras.toISOString().split('T')[0];
          document.getElementById('dataFim').value = hoje.toISOString().split('T')[0];
          
          filters.dataInicio = tresMesesAtras.toISOString().split('T')[0];
          filters.dataFim = hoje.toISOString().split('T')[0];
        }

        // Salvar preferências
        function saveChartPreferences() {
          localStorage.setItem('oursales:dashboard:charts', JSON.stringify(Array.from(activeCharts)));
        }

        // Carregar preferências
        function loadChartPreferences() {
          const saved = localStorage.getItem('oursales:dashboard:charts');
          if (saved) {
            activeCharts = new Set(JSON.parse(saved));
          }
        }

        // Inicializar
        document.addEventListener('DOMContentLoaded', async () => {
          loadChartPreferences();
          
          // Aplicar filtro de data padrão (3 meses atrás até hoje)
          applyDefaultDateFilter();
          
          await loadIndustrias();
          await loadAllCharts();
          
          // Botão OK para confirmar filtro
          document.getElementById('confirmarFiltroBtn').addEventListener('click', () => {
            updateDateFilters();
          });
          
          // Permitir Enter nos campos de data
          document.getElementById('dataInicio').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
              updateDateFilters();
            }
          });
          
          document.getElementById('dataFim').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
              updateDateFilters();
            }
          });
          
          // Modal para adicionar resumo
          const addSummaryModal = document.getElementById('addSummaryModal');
          const closeSummaryModal = document.getElementById('closeSummaryModal');
          
          // Função compartilhada para prevenir scroll
          let preventScrollHandler = null;
          let savedScrollPosition = 0;
          
          // Função para abrir modal
          function openModal() {
            // Salvar posição do scroll antes de bloquear
            savedScrollPosition = window.scrollY || window.pageYOffset || document.documentElement.scrollTop;
            
            // Bloquear scroll da página
            document.documentElement.classList.add('modal-open');
            document.body.classList.add('modal-open');
            document.body.style.top = `-${savedScrollPosition}px`;
            document.body.style.position = 'fixed';
            document.body.style.width = '100%';
            
            // Prevenir scroll com eventos (exceto dentro do modal)
            preventScrollHandler = (e) => {
              // Permitir scroll apenas dentro da área de conteúdo do modal
              const target = e.target;
              const chartCategories = target.closest('.chart-categories');
              
              // Se o evento está dentro da área de scroll do modal, permitir
              if (chartCategories) {
                return; // Permitir scroll dentro do conteúdo do modal
              }
              
              // Bloquear scroll em qualquer outro lugar (página de fundo, overlay, etc.)
              e.preventDefault();
              e.stopPropagation();
              return false;
            };
            
            // Adicionar listeners para prevenir scroll
            document.addEventListener('wheel', preventScrollHandler, { passive: false });
            document.addEventListener('touchmove', preventScrollHandler, { passive: false });
            document.addEventListener('scroll', preventScrollHandler, { passive: false });
            window.addEventListener('scroll', preventScrollHandler, { passive: false });
            
            // Atualizar visibilidade dos cards baseado nos gráficos já adicionados
            document.querySelectorAll('.chart-option-card').forEach(card => {
              const chartId = card.dataset.chart;
              if (activeCharts.has(chartId)) {
                card.style.opacity = '0.5';
                card.style.pointerEvents = 'none';
                const btn = card.querySelector('.chart-option-add-btn');
                if (btn) {
                  btn.textContent = 'Já adicionado';
                  btn.disabled = true;
                }
              } else {
                card.style.opacity = '1';
                card.style.pointerEvents = 'auto';
                const btn = card.querySelector('.chart-option-add-btn');
                if (btn) {
                  btn.textContent = 'Adicionar';
                  btn.disabled = false;
                }
              }
            });
            
            addSummaryModal.style.display = 'flex';
            addSummaryModal.classList.add('active');
            
            // Desabilitar foco em elementos de navegação
            const navLinks = document.querySelectorAll('nav a, header a, header button');
            navLinks.forEach(link => {
              link.setAttribute('tabindex', '-1');
            });
          }

          // Função para fechar modal
          function closeModal() {
            // Fechar modal primeiro
            addSummaryModal.style.display = 'none';
            addSummaryModal.classList.remove('active');
            
            // Remover listeners de scroll
            if (preventScrollHandler) {
              document.removeEventListener('wheel', preventScrollHandler);
              document.removeEventListener('touchmove', preventScrollHandler);
              document.removeEventListener('scroll', preventScrollHandler);
              window.removeEventListener('scroll', preventScrollHandler);
              preventScrollHandler = null;
            }
            
            // Restaurar classes e estilos do body
            document.documentElement.classList.remove('modal-open');
            document.body.classList.remove('modal-open');
            document.body.style.top = '';
            document.body.style.position = '';
            document.body.style.width = '';
            document.body.style.overflow = '';
            document.documentElement.style.overflow = '';
            
            // Restaurar posição do scroll
            if (savedScrollPosition > 0) {
              window.scrollTo({
                top: savedScrollPosition,
                behavior: 'instant'
              });
              savedScrollPosition = 0;
            }
            
            // Restaurar tabindex dos elementos de navegação
            const navLinks = document.querySelectorAll('nav a, header a, header button');
            navLinks.forEach(link => {
              link.removeAttribute('tabindex');
            });
          }

          document.getElementById('addSummaryBtn').addEventListener('click', openModal);
          
          closeSummaryModal.addEventListener('click', closeModal);
          
          // Fechar modal ao clicar fora
          addSummaryModal.addEventListener('click', (e) => {
            if (e.target === addSummaryModal) {
              closeModal();
            }
          });

          // Fechar modal com ESC
          document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && addSummaryModal.style.display === 'flex') {
              closeModal();
            }
          });

          // Navegação por abas
          document.querySelectorAll('.modal-tab').forEach(tab => {
            tab.addEventListener('click', () => {
              const category = tab.dataset.category;
              
              // Atualizar tabs
              document.querySelectorAll('.modal-tab').forEach(t => t.classList.remove('active'));
              tab.classList.add('active');
              
              // Atualizar seções
              document.querySelectorAll('.category-section').forEach(section => {
                section.classList.remove('active');
                section.style.display = 'none';
              });
              
              const activeSection = document.querySelector(`.category-section[data-category="${category}"]`);
              if (activeSection) {
                activeSection.classList.add('active');
                activeSection.style.display = 'flex';
              }
            });
          });
          
          // Adicionar gráfico ao clicar no botão
          document.querySelectorAll('.chart-option-add-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
              e.stopPropagation();
              const card = btn.closest('.chart-option-card');
              const chartId = card.dataset.chart;
              
              if (chartId && chartTypes[chartId]) {
                activeCharts.add(chartId);
                closeModal(); // Fechar modal corretamente para restaurar scroll
                loadChart(chartId);
                saveChartPreferences();
              }
            });
          });
          
          // Adicionar gráfico ao clicar no card inteiro
          document.querySelectorAll('.chart-option-card').forEach(card => {
            card.addEventListener('click', (e) => {
              if (e.target.classList.contains('chart-option-add-btn')) {
                return; // Já tratado acima
              }
              const chartId = card.dataset.chart;
              if (chartId && chartTypes[chartId]) {
                activeCharts.add(chartId);
                closeModal(); // Fechar modal corretamente para restaurar scroll
                loadChart(chartId);
                saveChartPreferences();
              }
            });
          });
        });
      })();
    </script>

  </body>
</html>
